<!doctype html><html>
<head>
<title>
苹果内购流程 :: My New Hugo Site
</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name=revised content="2021-09-07T07:28:50 UTC">
<meta name=description content>
<title>苹果内购流程 :: My New Hugo Site</title>
<link rel="shortcut icon" href=/images/favicon.png type=image/x-icon>
<link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css integrity=sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z crossorigin=anonymous>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.css>
<script src=https://code.jquery.com/jquery-3.5.1.min.js></script>
<link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel=stylesheet>
<link rel=stylesheet type=text/css href=https://fangfeixiong.github.io/sass/layout.css>
<link rel=stylesheet type=text/css href=https://fangfeixiong.github.io/css/style.main.css>
<link rel=stylesheet type=text/css href=https://fangfeixiong.github.io/css/style.menu.css>
<link rel=stylesheet type=text/css href=https://fangfeixiong.github.io/sass/shortcodes/notice.css>
<link rel=stylesheet type=text/css href=https://fangfeixiong.github.io/sass/shortcodes/tabs.css>
<link rel=stylesheet type=text/css href=https://fangfeixiong.github.io/sass/shortcodes/panel.css>
<link rel=stylesheet type=text/css href=https://fangfeixiong.github.io/sass/shortcodes/columns.css>
<link rel=stylesheet type=text/css href=https://fangfeixiong.github.io/sass/shortcodes/children.css>
<link rel=stylesheet type=text/css href=https://fangfeixiong.github.io/sass/shortcodes/attachments.css>
<link rel=stylesheet type=text/css href=https://fangfeixiong.github.io/sass/shortcodes/alert.css>
<link rel=stylesheet type=text/css href=/css/docport.css>
<script src=/js/docport.js></script>
<script type=text/javascript>var baseurl="https://fangfeixiong.github.io/"</script>
</head>
<body data-url=/ios/in-app-purchase/>
<style type=text/css>#debug{display:-webkit-box;display:-ms-flexbox;display:flex;line-height:3.5rem;margin-bottom:.35rem;padding:0 2rem;position:fixed;left:0;right:0;top:0;top:0;min-height:150px;background-color:#fff;border:3px solid red;z-index:10000;word-wrap:all;overflow:auto}</style>
<header>
<div>
<div class="burger single">
<a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')">&#9776;</a>
</div>
<div>
<a class=baselink href=https://fangfeixiong.github.io/>My New Hugo Site</a>
</div>
</div>
</header>
<article>
<aside class=single>
<div class=search>
<div class=searchbox>
<input data-search-input id=search-by type=text placeholder="Type to search...">
</div>
<script type=text/javascript src=/vendor/lunr/lunr.min.js></script>
<script type=text/javascript src=/vendor/auto-complete/auto-complete.js></script>
<link href=/vendor/auto-complete/auto-complete.css rel=stylesheet>
<script type=text/javascript>var baseurl="https://fangfeixiong.github.io/"</script>
<script type=text/javascript src=/js/search.js></script>
</div>
<div id=close_menu>
<a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')">
<i class="fa fa-lg fa-times"></i>
</a>
</div>
<ul class=menu>
<li data-nav-id=https://fangfeixiong.github.io/weixin-mini/ class="dd-item haschildren
item_level_$level">
<i class="fas fa-chevron-right ddexp"></i>
<a href=/weixin-mini/>Weixin-minis</a>
<ul>
<li data-nav-id=https://fangfeixiong.github.io/weixin-mini/tips_2/ class="dd-item
item_level_$level">
<a href=/weixin-mini/tips_2/>微信小程序开发Tips_2</a>
</li>
<li data-nav-id=https://fangfeixiong.github.io/weixin-mini/tips_1/ class="dd-item
item_level_$level">
<a href=/weixin-mini/tips_1/>微信小程序开发Tips_1</a>
</li>
</ul>
</li>
<li data-nav-id=https://fangfeixiong.github.io/ios/ class="dd-item parent haschildren
item_level_$level">
<i class="fas fa-chevron-down ddexp"></i>
<a href=/ios/>IOS</a>
<ul>
<li data-nav-id=https://fangfeixiong.github.io/ios/fmdb-use/ class="dd-item
item_level_$level">
<a href=/ios/fmdb-use/>FMDB的使用</a>
</li>
<li data-nav-id=https://fangfeixiong.github.io/ios/privacy/ class="dd-item
item_level_$level">
<a href=/ios/privacy/>iOS 隐私使用说明（Privacy Usage Description）</a>
</li>
<li data-nav-id=https://fangfeixiong.github.io/ios/reachability/ class="dd-item
item_level_$level">
<a href=/ios/reachability/>iOS判断是否连接网络</a>
</li>
<li data-nav-id=https://fangfeixiong.github.io/ios/doubleclick-input-scalechange/ class="dd-item
item_level_$level">
<a href=/ios/doubleclick-input-scalechange/>WKWebView 禁用双击缩放和横向滚动</a>
</li>
<li data-nav-id=https://fangfeixiong.github.io/ios/is-ipad/ class="dd-item
item_level_$level">
<a href=/ios/is-ipad/>判断当前设备是否是iPad</a>
</li>
<li data-nav-id=https://fangfeixiong.github.io/ios/in-app-purchase/ class="dd-item parent active
item_level_$level">
<a href=/ios/in-app-purchase/>苹果内购流程</a>
</li>
<li data-nav-id=https://fangfeixiong.github.io/ios/visitor-can-recharge/ class="dd-item
item_level_$level">
<a href=/ios/visitor-can-recharge/>苹果审核，关于未登录时购买内容，引导登录时需要提供游客充值的入口</a>
</li>
</ul>
</li>
</ul>
</aside>
<section class="page single">
<nav id=ariane aria-label=breadcrumb>
<ol class=ariane>
<li>
<a class=text-link href=https://fangfeixiong.github.io/>
Home
</a>
</li>
<li>
<a class=text-link href=/ios/>
IOS
</a>
</li>
<li class=active>
苹果内购流程
</li>
</ol>
</nav>
<h1>苹果内购流程</h1>
<div class=jump-to-section>
<span onclick="$h=$(this),$h.next('nav').slideToggle(100,function(){$h.children('i').attr('class',function(){return $h.next('nav').is(':visible')?'fas fa-chevron-down':'fas fa-chevron-right'})})">
<span class="fas fa-align-right"></span>
Jump to Section
<i class="fas fa-chevron-right"></i>
</span>
<nav id=TableOfContents>
<ul>
<li>
<ul>
<li></li>
</ul>
</li>
</ul>
</nav>
</div>
<div class=content>
<h4 ref=登录itunesconnect>登录iTunesconnect</h4><a class=anchor id=登录itunesconnect></a>
<p>1.登录<a href=https://itunesconnect.apple.com/>iTunes Connect</a></p>
<h4 ref=协议税务和银行业务-信息完善>协议、税务和银行业务 信息完善</h4><a class=anchor id=协议税务和银行业务-信息完善></a>
<p>1.选择协议、税务和银行业务项，如下图所示
<img src=selectPanel.png alt=选择协议、税务和银行业务的图片></p>
<p>2.选择Request
<img src=protocolTaxBank.png alt=协议、税务和银行业务界面></p>
<p>按照一步步操作即可,等待审核（需要一点时间可以过一天再看），完毕后即可得到上图Contracts In Effects的一条PaidApplication信息！</p>
<p>3.编辑联系信息
<img src=contactInformation.png alt=联系信息界面></p>
<p>所有的信息填写同一个人即可</p>
<p>4.税务信息
<img src=taxInformation-01.png alt=税务信息>
<img src=taxInformation-02.png alt=税务信息>
<img src=taxInformation-03.png alt=税务信息>
<img src=taxInformation-04.png alt=税务信息></p>
<p>5.银行信息填写
CNAPS Code <a href=http://www.tui78.com/bank/>银行网点联行号 查询网址</a> 需要哪个银行直接去对应银行链接里面找就行</p>
<p><img src=bankingInformation.png alt=银行信息></p>
<p>所有信息填写完毕后我们就可以开始编辑内购项</p>
<h4 ref=编辑内购项>编辑内购项</h4><a class=anchor id=编辑内购项></a>
<p>1.进入iTunes Connect 首界面，选择我的App，选中你需要加入内购的App。</p>
<p>2.内购项目
<img src=purchaseItems.png alt=内购完成图片></p>
<p>点击+按钮添加自己的内购项目</p>
<p>比如我们的应用是虚拟货币，所以我们选择消耗型,根据需要选择对应的类型，如下图</p>
<p><img src=selectPurchasePanel.png alt=内购完成图片></p>
<p>填写内购项的信息
<img src=purchaseItem1-01.png alt=内购项信息1>
<img src=purchaseItem1-02.png alt=内购项信息2></p>
<p>这里注意图片对应app内部的相应的选项
<img src=purchaseItem1-03.png alt=内购项信息3></p>
<h4 ref=内购代码>内购代码</h4><a class=anchor id=内购代码></a>
<p>1.从自己的服务器上获取充值选项数据，用于展示选择项，每一项对应一个内购项目,带有内购项的ID信息</p>
<p><img src=rechargePanel.PNG alt=内购选项></p>
<p>2.向苹果服务器请求内购信息，根据内购项的ID列表</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc> <span style=color:#f92672>-</span>(<span style=color:#66d9ef>void</span>)requestAppleProducts{
     SKProductsRequest <span style=color:#f92672>*</span>productsRequest<span style=color:#f92672>=</span>[[SKProductsRequest alloc] initWithProductIdentifiers:[NSSet setWithArray:<span style=color:#ae81ff>@[</span><span style=color:#960050;background-color:#1e0010>你的内购项的</span>ID列表<span style=color:#ae81ff>]</span>];
     productsRequest.delegate<span style=color:#f92672>=</span>self;
     [productsRequest start];
 }


 <span style=color:#f92672>-</span>(<span style=color:#66d9ef>void</span>)productsRequest:(SKProductsRequest <span style=color:#f92672>*</span>)request didReceiveResponse:(SKProductsResponse <span style=color:#f92672>*</span>)response
 {
     NSArray<span style=color:#f92672>&lt;</span>SKProduct<span style=color:#f92672>*&gt;</span> <span style=color:#f92672>*</span>products<span style=color:#f92672>=</span>[response.products sortedArrayWithOptions:NSSortConcurrent usingComparator:<span style=color:#f92672>^</span>NSComparisonResult(SKProduct obj1, SKProduct obj2) {
         <span style=color:#66d9ef>return</span> [obj1.price compare:obj2.price];
     }];
 }

</code></pre></div><p>3.选择一个充值项，充值调用</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc>
<span style=color:#75715e>//请求充值
</span><span style=color:#75715e></span>-(<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>requestPurchase</span>
{
  <span style=color:#75715e>//监听内购处理过程
</span><span style=color:#75715e></span>  [[SKPaymentQueue defaultQueue] addTransactionObserver:self];

  SKProduct <span style=color:#f92672>*</span>product<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>选中的项对应的</span>product;
  SKPayment <span style=color:#f92672>*</span>payment<span style=color:#f92672>=</span>[SKPayment paymentWithProduct:product];
  [[SKPaymentQueue defaultQueue] addPayment:payment];<span style=color:#75715e>//执行内购
</span><span style=color:#75715e></span>}


<span style=color:#75715e>//内购支付结果处理
</span><span style=color:#75715e></span>-(<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>paymentQueue:</span>(SKPaymentQueue <span style=color:#f92672>*</span>)queue <span style=color:#a6e22e>updatedTransactions:</span>(NSArray<span style=color:#f92672>&lt;</span>SKPaymentTransaction <span style=color:#f92672>*&gt;</span> <span style=color:#f92672>*</span>)transactions
{
  <span style=color:#66d9ef>for</span>(SKPaymentTransaction <span style=color:#f92672>*</span>transation <span style=color:#66d9ef>in</span> transactions){
      <span style=color:#66d9ef>switch</span> (transation.transactionState) {
          <span style=color:#66d9ef>case</span> SKPaymentTransactionStatePurchasing:
              NSLog(<span style=color:#e6db74>@&#34;正在唤起支付，请稍候&#34;</span>);
              <span style=color:#66d9ef>break</span>;
          <span style=color:#66d9ef>case</span> SKPaymentTransactionStatePurchased:
              [queue finishTransaction:transation];
              [self handleTransaction:transation];
              NSLog(<span style=color:#e6db74>@&#34;充值成功&#34;</span>)
              <span style=color:#66d9ef>break</span>;
          <span style=color:#66d9ef>case</span> SKPaymentTransactionStateFailed:
              [queue finishTransaction:transation];
              NSLog(<span style=color:#e6db74>@&#34;充值失败&#34;</span>);
              <span style=color:#66d9ef>break</span>;
          <span style=color:#66d9ef>case</span> SKPaymentTransactionStateRestored:
              [queue finishTransaction:transation];
              [self handleTransaction:transation];
              NSLog(<span style=color:#e6db74>@&#34;充值失败&#34;</span>);
              <span style=color:#66d9ef>break</span>;
          <span style=color:#66d9ef>case</span> SKPaymentTransactionStateDeferred:
              NSLog(<span style=color:#e6db74>@&#34;等待充值结果&#34;</span>);
              <span style=color:#66d9ef>break</span>;
          <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
              NSLog(<span style=color:#e6db74>@&#34;未知错误&#34;</span>);
              <span style=color:#66d9ef>break</span>;
      }
  }
}

-(<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>handleTransaction:</span>(SKPaymentTransaction <span style=color:#f92672>*</span>)transaction{
  NSData <span style=color:#f92672>*</span>receiptData<span style=color:#f92672>=</span>[NSData dataWithContentsOfURL:[[NSBundle mainBundle] appStoreReceiptURL]];
  <span style=color:#75715e>//先把将app内购的结果存储起来，如果出现了意外情况，断网了等没有将结果发送到自己的服务器，那么下次app打开时，可以查询本地没有校验的存储，然后发送给自己的服务端校验！
</span><span style=color:#75715e></span>
  <span style=color:#75715e>//我的ApplePayDataManager 本地存储帮助类
</span><span style=color:#75715e></span>  [[ApplePayDataManager Instance] insertPayOrderNo:transaction.transactionIdentifier receiveData:[receiptData base64EncodedStringWithOptions:<span style=color:#ae81ff>0</span>]];

  <span style=color:#75715e>//把receiptData 发送给自己的服务器，服务器去调用苹果的接口验证，如果校验完毕从本地存储中删除存储的对应的ReceiveData记录。
</span><span style=color:#75715e></span>}


</code></pre></div><h4 ref=内购的提交审核>内购的提交审核</h4><a class=anchor id=内购的提交审核></a>
<ol>
<li>
<p>如果是第一次内购提交审核，那么App提交审核界面上会多出内购项添加的模块，要把需要的所有内购项都添加进来，和App一起提交审核，不然App什么是没法通过的。</p>
</li>
<li>
<p>非常重要，切记把需要的内购项目都添加到提交审核页面对应的块中！</p>
</li>
</ol>
<h4 ref=校验结果对照>校验结果对照</h4><a class=anchor id=校验结果对照></a>
<p><img src=response-01.png alt=key的解释>
<img src=response-02.png alt=status的解释></p>
<h4 ref=内购的附加信息>内购的附加信息</h4><a class=anchor id=内购的附加信息></a>
<p><a href=https://github.com/PlayLive/Practice/tree/master/FMDBUse>我的ApplePayDataManager类</a></p>
<p><a href=https://developer.apple.com/library/content/documentation/NetworkingInternet/Conceptual/StoreKitGuide/Introduction.html>App内购官方参考</a></p>
<p><a href=https://developer.apple.com/library/content/releasenotes/General/ValidateAppStoreReceipt/Chapters/ValidateRemotely.html#//apple_ref/doc/uid/TP40010573-CH104-SW1>App内购流程官方参考</a></p>
<p>处于测试阶段的ReceiveData校验地址： <a href=https://sandbox.itunes.apple.com/verifyReceipt>https://sandbox.itunes.apple.com/verifyReceipt</a></p>
<p>正式上线后的ReceiveData校验地址： <a href=https://buy.itunes.apple.com/verifyReceipt>https://buy.itunes.apple.com/verifyReceipt</a></p>
</div>
<div class=chevrons>
<a class=next href=/ios/visitor-can-recharge/ title=苹果审核，关于未登录时购买内容，引导登录时需要提供游客充值的入口 style=margin-right:0>
<div>
<p>Next page</p>
<label>苹果审核，关于未登录时购买内容，引导登录时需要提供游客充值的入口</label>
</div>
<i class="fas fa-arrow-right" style=font-size:1.7em></i></a>
</div>
</section>
<section class="right-menu single">
<div class=TableOfContents>
<label><i class="fas fa-align-right"></i>&nbsp;&nbsp;What's on this page</label>
<nav>
<ul>
<li><a href=/ios/in-app-purchase/>苹果内购流程</a></li>
</ul>
</nav>
<nav id=TableOfContents>
<ul>
<li>
<ul>
<li></li>
</ul>
</li>
</ul>
</nav>
</div>
<div class=Actions>
<nav>
<ul>
</ul>
</nav>
</div>
</section>
</article>
<footer>
Create a content/_layout/footer/_index.md file to customize the footer content !
</footer>
</body>
</html>