<!doctype html><html>
<head>
<title>
IOS :: 放飞熊的博客
</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name=revised content="2021-09-24T09:01:15 UTC">
<meta name=description content>
<title>IOS :: 放飞熊的博客</title>
<link rel="shortcut icon" href=/images/favicon.png type=image/x-icon>
<link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css integrity=sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z crossorigin=anonymous>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.css>
<script src=https://code.jquery.com/jquery-3.5.1.min.js></script>
<link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel=stylesheet>
<link rel=stylesheet type=text/css href=https://fangfeixiong.github.io/sass/layout.css>
<link rel=stylesheet type=text/css href=https://fangfeixiong.github.io/css/style.main.css>
<link rel=stylesheet type=text/css href=https://fangfeixiong.github.io/css/style.menu.css>
<link rel=stylesheet type=text/css href=https://fangfeixiong.github.io/sass/shortcodes/notice.css>
<link rel=stylesheet type=text/css href=https://fangfeixiong.github.io/sass/shortcodes/tabs.css>
<link rel=stylesheet type=text/css href=https://fangfeixiong.github.io/sass/shortcodes/panel.css>
<link rel=stylesheet type=text/css href=https://fangfeixiong.github.io/sass/shortcodes/columns.css>
<link rel=stylesheet type=text/css href=https://fangfeixiong.github.io/sass/shortcodes/children.css>
<link rel=stylesheet type=text/css href=https://fangfeixiong.github.io/sass/shortcodes/attachments.css>
<link rel=stylesheet type=text/css href=https://fangfeixiong.github.io/sass/shortcodes/alert.css>
<link rel=stylesheet type=text/css href=/css/docport.css>
<script src=/js/docport.js></script>
<script type=text/javascript>var baseurl="https://fangfeixiong.github.io/"</script>
</head>
<body data-url=/ios/>
<style type=text/css>#debug{display:-webkit-box;display:-ms-flexbox;display:flex;line-height:3.5rem;margin-bottom:.35rem;padding:0 2rem;position:fixed;left:0;right:0;top:0;top:0;min-height:150px;background-color:#fff;border:3px solid red;z-index:10000;word-wrap:all;overflow:auto}</style>
<header>
<div>
<div class=burger>
<a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')">&#9776;</a>
</div>
<div>
<a class=baselink href=https://fangfeixiong.github.io/>放飞熊的博客</a>
</div>
</div>
</header>
<article>
<aside>
<div class=search>
<div class=searchbox>
<input data-search-input id=search-by type=text placeholder="Type to search...">
</div>
<script type=text/javascript src=/vendor/lunr/lunr.min.js></script>
<script type=text/javascript src=/vendor/auto-complete/auto-complete.js></script>
<link href=/vendor/auto-complete/auto-complete.css rel=stylesheet>
<script type=text/javascript>var baseurl="https://fangfeixiong.github.io/"</script>
<script type=text/javascript src=/js/search.js></script>
</div>
<div id=close_menu>
<a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')">
<i class="fa fa-lg fa-times"></i>
</a>
</div>
<ul class=menu>
<li data-nav-id=https://fangfeixiong.github.io/unity3d/ class="dd-item haschildren
item_level_$level">
<i class="fas fa-chevron-right ddexp"></i>
<a href=/unity3d/>Unity3ds</a>
<ul>
<li data-nav-id=https://fangfeixiong.github.io/unity3d/flutter-unity-view-wiget/ class="dd-item
item_level_$level">
<a href=/unity3d/flutter-unity-view-wiget/>flutter-unity-view-widget使用问题和解决办法汇总</a>
</li>
</ul>
</li>
<li data-nav-id=https://fangfeixiong.github.io/weixin-mini/ class="dd-item haschildren
item_level_$level">
<i class="fas fa-chevron-right ddexp"></i>
<a href=/weixin-mini/>Weixin-minis</a>
<ul>
<li data-nav-id=https://fangfeixiong.github.io/weixin-mini/tips_2/ class="dd-item
item_level_$level">
<a href=/weixin-mini/tips_2/>微信小程序开发Tips_2</a>
</li>
<li data-nav-id=https://fangfeixiong.github.io/weixin-mini/tips_1/ class="dd-item
item_level_$level">
<a href=/weixin-mini/tips_1/>微信小程序开发Tips_1</a>
</li>
</ul>
</li>
<li data-nav-id=https://fangfeixiong.github.io/ios/ class="dd-item parent active haschildren
item_level_$level">
<i class="fas fa-chevron-down ddexp"></i>
<a href=/ios/>IOS</a>
<ul>
<li data-nav-id=https://fangfeixiong.github.io/ios/fmdb-use/ class="dd-item
item_level_$level">
<a href=/ios/fmdb-use/>FMDB的使用</a>
</li>
<li data-nav-id=https://fangfeixiong.github.io/ios/privacy/ class="dd-item
item_level_$level">
<a href=/ios/privacy/>iOS 隐私使用说明（Privacy Usage Description）</a>
</li>
<li data-nav-id=https://fangfeixiong.github.io/ios/reachability/ class="dd-item
item_level_$level">
<a href=/ios/reachability/>iOS判断是否连接网络</a>
</li>
<li data-nav-id=https://fangfeixiong.github.io/ios/doubleclick-input-scalechange/ class="dd-item
item_level_$level">
<a href=/ios/doubleclick-input-scalechange/>WKWebView 禁用双击缩放和横向滚动</a>
</li>
<li data-nav-id=https://fangfeixiong.github.io/ios/is-ipad/ class="dd-item
item_level_$level">
<a href=/ios/is-ipad/>判断当前设备是否是iPad</a>
</li>
<li data-nav-id=https://fangfeixiong.github.io/ios/in-app-purchase/ class="dd-item
item_level_$level">
<a href=/ios/in-app-purchase/>苹果内购流程</a>
</li>
<li data-nav-id=https://fangfeixiong.github.io/ios/visitor-can-recharge/ class="dd-item
item_level_$level">
<a href=/ios/visitor-can-recharge/>苹果审核，关于未登录时购买内容，引导登录时需要提供游客充值的入口</a>
</li>
</ul>
</li>
</ul>
</aside>
<section class=page>
<nav id=ariane aria-label=breadcrumb>
<ol class=ariane>
<li>
<a class=text-link href=https://fangfeixiong.github.io/>
Home
</a>
</li>
<li>
<a class=text-link href=/ios/>
IOS
</a>
</li>
<li class=active>
FMDB的使用
</li>
</ol>
</nav>
<h1>FMDB的使用</h1>
<div class=jump-to-section>
<span onclick="$h=$(this),$h.next('nav').slideToggle(100,function(){$h.children('i').attr('class',function(){return $h.next('nav').is(':visible')?'fas fa-chevron-down':'fas fa-chevron-right'})})">
<span class="fas fa-align-right"></span>
Jump to Section
<i class="fas fa-chevron-right"></i>
</span>
<nav id=TableOfContents>
<ul>
<li>
<ul>
<li></li>
</ul>
</li>
</ul>
</nav>
</div>
<div class=content>
<h4 ref=fmdb的使用>FMDB的使用</h4><a class=anchor id=fmdb的使用></a>
<p>最近app中使用了苹果支付来充值，然后苹果支付结果是直接返回给客户端的，而不像支付宝和微信支付等支付平台，支付完成后会回调后台。</p>
<p>苹果支付返回的结果是一个超级长的ReceiveData的字符串。然后得到字符串之后向自己的后台发请求，让自己的后台去请求苹果的服务器来校验结果。当然也可以客服端直接调用苹果的服务器来的到校验结果，然后发给自己的服务器，但是这显然是不靠谱的，容易被篡改。所以还是让自己的服务端去校验，才比较靠谱。</p>
<p>这里我们会遇到一个问题，如果我们得到苹果的支付结果后，还没来得及发给自己的后端校验，遇到突然就断网了，app崩溃了，手机没电关机了等情况。那我们得到的支付结果ReceiveData就直接丢失了，再也找不到了，用户充了钱，却没有得到应有的虚拟货币，那就尴尬了。</p>
<p>所以了我们就想到一个方案，收到苹果的支付结果后，先把他存储在本地。然后向自己的后端发出请求，如果自己的服务端校验完成，返回结果后，就把本地存储的对应的记录删除掉。</p>
<p>每次app开启的时候，查询所有未校验的支付结果，依次发给自己的服务端进行校验，这样就不会漏掉了。当然数据可以以文件的形式存储，但是作者觉得用数据库存储可能更方便一些，以后可能也会有其他的数据需要存储，所以就决定学习一下FMDB的使用。FMDB可以直接通过CocosPod 下载集成，很方便。</p>
<h4 ref=先定义一些常量比如数据库名表名列名方便后面操作的引用>先定义一些常量，比如数据库名、表名、列名，方便后面操作的引用。</h4><a class=anchor id=先定义一些常量比如数据库名表名列名方便后面操作的引用></a>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc>
  <span style=color:#75715e>//数据库名
</span><span style=color:#75715e></span>  <span style=color:#75715e>#define DataBase_Name @&#34;yourDataBaseName.sqlite&#34;
</span><span style=color:#75715e></span>  <span style=color:#75715e>//表名
</span><span style=color:#75715e></span>  <span style=color:#75715e>#define TableName_Table1 @&#34;table1&#34;
</span><span style=color:#75715e></span>
  <span style=color:#75715e>//列1 名称
</span><span style=color:#75715e></span>  <span style=color:#75715e>#define Table1_ColumnName1 @&#34;columnName1&#34;
</span><span style=color:#75715e></span>  <span style=color:#75715e>//列2 名称
</span><span style=color:#75715e></span>  <span style=color:#75715e>#define Table1_ColumnName2 @&#34;columnName2&#34;
</span><span style=color:#75715e></span>  <span style=color:#75715e>//列3 名称
</span><span style=color:#75715e></span>  <span style=color:#75715e>#define Table1_ColumnName3 @&#34;columnName3&#34;
</span></code></pre></div><h4 ref=1创建数据库>1.创建数据库</h4><a class=anchor id=1创建数据库></a>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc> NSString <span style=color:#f92672>*</span>documentPath<span style=color:#f92672>=</span>[NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) lastObject];
 NSString <span style=color:#f92672>*</span>databasePath<span style=color:#f92672>=</span>[documentPath stringByAppendingPathComponent:DataBase_Name];

 FMDatabase <span style=color:#f92672>*</span>database<span style=color:#f92672>=</span>[FMDatabase databaseWithPath:databasePath];

</code></pre></div><h4 ref=2创建表>2.创建表</h4><a class=anchor id=2创建表></a>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=color:#66d9ef>if</span>([database open])
{
<span style=color:#66d9ef>BOOL</span> createTableResult<span style=color:#f92672>=</span>[database executeUpdate: [NSString stringWithFormat:<span style=color:#e6db74>@&#34;create table %@ (%@ text,%@ text,%@ integer)&#34;</span>,TableName_Table1,Table1_ColumnName1,Table1_ColumnName2,Table1_ColumnName3]];
[database close];
}
</code></pre></div><h4 ref=3插入数据>3.插入数据</h4><a class=anchor id=3插入数据></a>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=color:#66d9ef>if</span>([database open])
{
<span style=color:#66d9ef>BOOL</span> insertResult<span style=color:#f92672>=</span>[database executeUpdate:[NSString stringWithFormat:<span style=color:#e6db74>@&#34;insert into %@ (%@,%@,%@) values (&#39;%@&#39;,&#39;%@&#39;,%ld)&#34;</span>,TableName_Table1,Table1_ColumnName1,Table1_ColumnName2,Table1_ColumnName3,<span style=color:#e6db74>@&#34;testColomnValue1&#34;</span>,<span style=color:#e6db74>@&#34;testColomnValue2&#34;</span>,<span style=color:#ae81ff>10001</span>]];
  [database close];
}
</code></pre></div><h4 ref=4获取数据>4.获取数据</h4><a class=anchor id=4获取数据></a>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=color:#66d9ef>if</span>([database open])
{
  FMResultSet <span style=color:#f92672>*</span>resultSet<span style=color:#f92672>=</span> [database executeQuery:[NSString stringWithFormat:<span style=color:#e6db74>@&#34;select * from %@ where %@=%ld&#34;</span>,TableName_Table1,Table1_ColumnName3,<span style=color:#ae81ff>10001</span>]];
  <span style=color:#66d9ef>if</span>(resultSet<span style=color:#f92672>==</span>nil)
  {
      NSLog(<span style=color:#e6db74>@&#34;select result is null&#34;</span>);
      <span style=color:#66d9ef>return</span> payOrderList;
  }
  <span style=color:#66d9ef>while</span>([resultSet next])
  {
     NSString <span style=color:#f92672>*</span>columnName1Value<span style=color:#f92672>=</span>[resultSet stringForColumn:Table1_ColumnName1];
     NSString <span style=color:#f92672>*</span>columnName2Value<span style=color:#f92672>=</span>[resultSet stringForColumn:Table1_ColumnName2];
  }
  [database close];
}
</code></pre></div><p>注意：FMResultSet 其实是对数据库的一个引用，必须在数据库开启的时候执行next方法，才能逐条获取导数据。如果关闭后执行next，是获取不到数据的。所以我们应该将FMResultSet的数据逐条获取出来，存储到自己的数据结构中，然后关闭数据库。</p>
<h4 ref=5删除数据>5.删除数据</h4><a class=anchor id=5删除数据></a>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-objc data-lang=objc><span style=color:#66d9ef>if</span>([database open])
{
  <span style=color:#66d9ef>BOOL</span> deleteResult<span style=color:#f92672>=</span>[database executeUpdate:[NSString stringWithFormat:<span style=color:#e6db74>@&#34;delete from %@ where %@=&#39;%@&#39; and %@=%ld&#34;</span>,TableName_Table1,Table1_ColumnName1,<span style=color:#e6db74>@&#34;testColomnValue1&#34;</span>];
  [database close];
}
</code></pre></div><p><a href=https://github.com/PlayLive/Practice/tree/master/FMDBUse>我的FMDB练习地代码</a></p>
</div>
<div class=chevrons>
<a class=next href=/ios/privacy/ title="iOS 隐私使用说明（Privacy Usage Description）" style=margin-right:0>
<div>
<p>Next page</p>
<label>iOS 隐私使用说明（Privacy Usage Description）</label>
</div>
<i class="fas fa-arrow-right" style=font-size:1.7em></i></a>
</div>
</section>
<section class=right-menu>
<div class=TableOfContents>
<label><i class="fas fa-align-right"></i>&nbsp;&nbsp;What's on this page</label>
<nav>
<ul>
<li><a href=/ios/>IOS</a></li>
</ul>
</nav>
</div>
<div class=Actions>
<nav>
<ul>
</ul>
</nav>
</div>
</section>
</article>
<footer>
Create a content/_layout/footer/_index.md file to customize the footer content !
</footer>
</body>
</html>